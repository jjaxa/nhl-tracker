<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NHL Player Tracker</title>

  <!-- jQuery (required by Select2) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Select2 for searchable dropdown -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; background-color: #f4f6f8; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: 40px auto; padding: 20px; background-color: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h1 { text-align: center; margin-bottom: 20px; color: #003366; }
    .player-select { width: 100%; margin-bottom: 15px; }
    button { width: 100%; padding: 10px; background-color: #007bff; color: white; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
    #results { margin-top: 25px; }
    .player-card { border: 1px solid #ccc; border-radius: 10px; padding: 10px 15px; margin: 10px 0; background: #f8f9fa; transition: background-color 0.3s; }
    .player-card:hover { background-color: #e8f0ff; }
    h3 { margin: 0 0 8px 0; color: #002244; }
    #last-updated { text-align: center; font-size: 14px; color: #555; margin-top: 10px; }
  </style>
</head>

<body>
  <div class="container">
    <h1>üèí NHL Player Tracker</h1>

    <form id="player-form">
      <select class="player-select" name="player_ids[]" multiple="multiple">
        {% for name, pid in players.items() %}
          <option value="{{ pid }}">{{ name }}</option>
        {% endfor %}
      </select>
      <button type="submit">Track Selected Players</button>
    </form>

    <div id="results"></div>
    <div id="last-updated"></div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const refreshInterval = 30000; // 30 seconds
    const form = document.getElementById("player-form");
    const resultsDiv = document.getElementById("results");
    const lastUpdatedDiv = document.getElementById("last-updated");

    // Initialize Select2 safely (fallback to normal <select> if it fails)
    try {
      if (window.$ && $.fn && $.fn.select2) {
        $(".player-select").select2({
          placeholder: "Search and select players...",
          allowClear: true
        });
      } else {
        console.warn("Select2 not available; using native multi-select.");
      }
    } catch (e) {
      console.warn("Select2 init error; using native multi-select.", e);
    }

    async function fetchStats() {
      const formData = new FormData(form);
      const response = await fetch("/live_stats", { method: "POST", body: formData });
      const data = await response.json();

      resultsDiv.innerHTML = "";
      for (const [name, stats] of Object.entries(data)) {
        const playerDiv = document.createElement("div");
        playerDiv.classList.add("player-card");
        playerDiv.innerHTML = `
          <h3>${name}</h3>
          <p><strong>${stats.label}</strong></p>
          <p>Shots on Goal: ${stats.shots}</p>
          <p>Goals: ${stats.goals}</p>
        `;
        resultsDiv.appendChild(playerDiv);
      }

      const now = new Date();
      lastUpdatedDiv.textContent = "üîÅ Last updated: " + now.toLocaleTimeString();
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      await fetchStats();
      startAutoRefresh();
    });

    let refreshTimer;
    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(fetchStats, refreshInterval);
      console.log("[AutoRefresh] Stats updating every 30 seconds");
    }
  });
  </script>
</body>
</html>
