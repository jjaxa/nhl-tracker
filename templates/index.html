<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NHL Player Tracker</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Select2 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      background: #0c1c2c;
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      padding: 30px;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .select2-container--default .select2-selection--multiple {
      background-color: #fff;
      color: #000;
      border-radius: 6px;
      padding: 5px;
      min-height: 48px;
    }
    #results {
      margin-top: 30px;
    }
    .player-card {
      background: #132639;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üèí NHL Player Tracker</h1>

    <form id="tracker-form" class="mb-4">
      <label for="player-select" class="form-label">Select players to track:</label>
      <select
        id="player-select"
        name="player_ids[]"
        class="form-select"
        multiple="multiple"
        style="width: 100%"
      >
        {% for name, pid in players.items() %}
        <option value="{{ pid }}">{{ name }}</option>
        {% endfor %}
      </select>

      <div class="mt-3 d-flex justify-content-center">
        <button type="submit" class="btn btn-primary px-4">
          Get Live Stats
        </button>
      </div>
    </form>

    <div id="results"></div>
  </div>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Select2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script>
    $(document).ready(function () {
      // Initialize Select2 with search
      $("#player-select").select2({
        placeholder: "Search or select players...",
        allowClear: true,
      });

      // Load saved players from localStorage
      const savedPlayers = JSON.parse(localStorage.getItem("trackedPlayers")) || [];
      if (savedPlayers.length > 0) {
        $("#player-select").val(savedPlayers).trigger("change");
      }

      // Submit form to fetch stats
      $("#tracker-form").on("submit", function (e) {
        e.preventDefault();
        const selected = $("#player-select").val() || [];

        // Save selected list for persistence
        localStorage.setItem("trackedPlayers", JSON.stringify(selected));

        if (selected.length === 0) {
          $("#results").html("<p>No players selected.</p>");
          return;
        }

        $("#results").html("<p>Loading...</p>");

        $.post("/live_stats", { "player_ids[]": selected }, function (data) {
          let html = "";
          for (const [name, stats] of Object.entries(data)) {
            html += `
              <div class="player-card">
                <h5>${name}</h5>
                <p><strong>{{ player.label }}</strong></p>
                <p>Shots on Goal: {{ player.shots }}</p>
                <p>Goals: {{ player.goals }}</p>
              </div>
            `;
          }

          // Show players even if no active game
          if (Object.keys(data).length === 0) {
            html = `
              <div class="alert alert-secondary text-center">
                <strong>No live data</strong> ‚Äî your selected players may not have games today.
              </div>
            `;
          }

          $("#results").html(html);
        }).fail(function () {
          $("#results").html(
            "<div class='alert alert-danger'>Error fetching stats.</div>"
          );
        });
      });
    });
  </script>
</body>
</html>
